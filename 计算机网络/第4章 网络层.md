计算机网络

# 第4章 网络层

本章的核心内容---网际协议IP，这是本书的一个重点内容，只有深入的掌握了IP协议的主要内容，才能理解互联网是怎样工作的。

本章的最重要内容是：

- 虚拟互连网络的概念
- IP地址与物理地址的关系
- 传统的分类的IP地址（包括子网掩码）和无分类域间路由选择CIDR
- 路由选择协议的工作原理

## 4.1 网络层提供的两种服务

互联网采用的设计思路是这样的：**网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务**，数据报是互联网设计者最初使用的名词，其实数据报（或IP数据报）就是我们经常使用的“分组”。（在本书中，数据报和分组时同义词，可以混用）

网络在发送分组时不需要先建立连接。每一个分组（也就是IP数据报）独立发送，与其前后的分组无关。**网络层不提供服务质量的承诺**，也就是说，所传送的分组可能出错，丢失，重复和失序，当然也不保证分组交付的时限。这就使得网络中的路由器比较简单，而且价格低廉。如果主机中的进程之间的通信是需要可靠的，那么就由网络的主机中的运输层负责（包括差错处理，流量控制等）

## 4.2 网际协议IP

网际协议IP是TCP/IP体系中两个最重要的协议之一，也是最重要的互联网标准协议之一。

与IP协议配套使用的还有三个协议：

- **地址解析协议ARP**
- **网际控制报文协议ICMP**
- **网际组管理协议IGMP**

IP要经常使用ARP协议。ICMP和IGMP要使用IP协议。由于网际协议IP是用来使互连起来的许多计算机网络能够进行通信的，因此TCP/IP协议中的网络层常常被称为**网际层**或**IP层**。

讨论网际协议IP之前，必须了解什么是虚拟互连网络。

### 4.2.1 虚拟互连网络

用户的需求是多种多样的，**没有一种单一的网络能够适应所有用户的需求**，另外，网络技术不断发展，新的网络不断推出。

将网络相互连接起来要使用一些**中间设备**。根据中间设备的层次，可以有以下四种不同的中间设备：

- 物理层使用的中间设备叫做**转发器**
- 数据链路层使用的中间设备叫**网桥**或**桥接器**
- 网络层使用的中间设备叫做**路由器**
- 网络层以上使用的中间设备叫做**网关**。用网关连接两个不兼容的系统需要在高层进行协议的转换。

当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，从网络层的角度看，这仍然是一个网络，一般不称为网络互连。网关由于比较复杂，目前用的比较少。因此我们讨论网络互连时，都是指用路由器进行网络互连和路由选择。**由于历史的原因，许多有关TCP/IP的文献曾经把网络层使用的路由器称为网关**。

### 4.2.2 分类的IP地址

#### 1.IP地址及其表示方法

IP地址的编制方法共经过了三个历史阶段：

- **分类的IP地址** 这是最基本的编制方法
- **子网的划分** 这是对最基本的编制方法的改进
- **形成超网** 这是比较新的无分类编制方法

分类的IP地址就是将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中第一个字段是网络号，他标志主句所连接到的网络。一个网络号在整个互联网范围内必须是唯一的。第二个字段是主机号，它标志该主机（或路由器）。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个IP地址在**整个互联网范围内是唯一的**。

- A类，B类和C类地址的网络号字段分别是1，2，3各字节长，而在网络号字段的最前面有1-3位的**类别位**，其数值分别规定为0，10，110
- A类，B类和C类地址的主机号字段分别为3，2，1个字节长
- D类地址（前4位是1110）用于**多播**（一对多通信）
- E类地址（前4位是1111）保留为以后用

#### 2.常用的三种类别的IP地址

IP地址具有以下一些重要特点

- 每一个IP地址都由网络号和主机号两部分组成。IP地址是一种**分等级的地址结构**。分两个等级的好处是：1.IP地址管理机构在分配IP地址时只分配网络号（第一级），而剩下的主机号（第二级）则由得到该网络号的单位自行分配。这样方便了IP地址的管理，2.路由器**仅根据目的主机所连接的网络号来进行转发分组**（而不考虑目的主机的主机号），这样就可以使路由表中的项目数大幅度减小，从而**减小了路由表所占的存储空间以及查找路由表的时间**。
- 实际上IP地址是标志一台主机（或路由器）和一条链路的接口。
- 按照互联网观点，一个网络是指具有相同网络号net-id的主机的集合，因此，**用转发器或网桥连接起来的若干个局域网仍为一个网络**
- 在IP地址中，所有分配到网络号的网络都是平等的

### 4.2.3 IP地址与硬件地址

**物理地址是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址**（因为IP地址是用软件实现的）

需要强调的是：

- **在IP层抽象的互联网上只能看到IP数据报**
- 虽然IP数据报首部有源站IP地址，但**路由器只根据目的站的IP地址的网络号进行路由选择**
- **在局域网的链路层，只能看见MAC帧**

### 4.2.4 地址解析协议ARP

**地址解析协议ARP**协议用来解决已经知道了一个及其的IP地址，需要找出其相应的硬件地址。

IP协议使用了ARP协议，在主机的**ARP高速缓存（APR cache）**中存放一个从IP地址到硬件地址的映射表，这个映射表经常动态更新。

- ARP进程在**本局域网**上广播发送一个ARP请求分组
- 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组
- 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下这个ARP请求分组，并向主机A发送ARP响应分组，同时在这个ARP响应分组中写入自己的硬件地址。由于其余的所有主机的IP地址都与ARP请求分组中要查询的IP地址不一致，因此都不理睬这个ARP请求分组。
- 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射

需要注意的是，ARP是解决**同一个局域网**上的主机或路由器的IP地址和硬件地址的映射问题。

### 4.2.5 IP数据报的格式

IP数据报的格式能够说明IP协议都具有什么功能。

一个IP数据报由首部和数据两部分组成。首部的前一部分是**固定长度**，共20字节，是所有IP数据报必须具有的。首部的固定部分的后面是一些**可选字段**，其长度是可变的。

#### 1.IP数据报首部的固定部分中的各字段

- **版本** 占4位，即IP协议的版本
- **首部长度** 占4位，可表示的最大十进制数值是15.
- **区分服务** 占8位，用来获得更好的服务。
- **总长度** 指首部和数据之和的长度，单位是字节。
- **标识** 占16位。
- **标志** 占3位
- **片位移** 占13位
- **生存时间** 占8位
- **协议** 占8位，协议字段指出此数据报携带的数据是何种协议，以便使目的主机的IP层知道应该将数据部分上交给哪个协议进行处理。
- **首部检验和** 占16位，这个字段**只检验数据报的首部，但不包括数据部分**
- **源地址** 占32位
- **目的地址** 占32位

#### 2.IP数据报首部的可变部分

在互联网上转发分组时，是从**一个路由器转发到下一个路由器**。

总之，在路由表中，对每一条路由最主要的是以下两个信息：

**（目的网络地址，下一跳地址）**

可以归纳出**转发分组算法**如下：

- 从数据包的首部提取目的主机的IP地址D，得出目的网络地址是N
- 若N就是此路由器直接相连的某个网络地址，则进行**直接交付**，不需要再经过其他的路由器，直接把数据报交付目的主机（这里包括把目的主机地址*D*转换为具体的硬件地址，把数据报封装为MAC帧，再发送此帧）负责就是间接交付，执行下一条。
- 若路由器中有目的地址为*D*的特定主机路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行下一条
- 若路由表中有到达网络*N*的路由，则把数据报传送给路由表中指明的下一跳路由器，否则，执行下一条。
- 报告转发分组出错

## 4.3 划分子网和构造超网

### 4.3.1 划分子网

#### 1.从两级IP地址到三级IP地址

在ARPANET的早期，IP地址的设计确实不够合理。

- IP地址空间的利用率有时很低
- 给每一个物理网络分配一个网络号会使**路由表变得更大**而使网络性能变坏
- 两级IP**不够灵活**

为了解决以上问题，又在IP地址中增加了一个**子网号字段**，使两级IP地址变成三级IP地址，这种做法叫做**划分子网**，或**子网寻址**或**子网路由选择**。

划分子网的基本思路如下：

- 一个拥有许多物理网络的单位，可以将所属的物理网络划分为若干个子网。
- 划分子网的方法是从网络的主机号借用若干位作为子网号，当然主机号也就相应较少了同样的位数。
- 凡是从其他网络发送给本单位某台主机的IP数据报，仍然是根据IP数据报的目的网络号找到连接在本单位网络上的路由器。但此路由器在收到IP数据报后，再按目的网络号和子网号找到目的子网，把IP数据报交付目的主机。

#### 2.子网掩码

从IP数据报的首部**无法看出**源主机或目的主机所连接的网络是否进行了子网的划分。我们使用**子网掩码**来解决这个问题。

现在的互联网的标标准规定：所有的网络都必须使用子网掩码，同时在路由器的路由表中也必须有子网掩码这一栏。如果一个网络不划分子网，那么该网络的子网掩码就使用**默认子网掩码**

A类地址的默认子网掩码是255.0.0.0

B类地址的默认子网掩码是255.255.0.0

C类地址的默认子网掩码是255.255.255.0

**子网掩码是一个网络或一个子网的重要属性**

### 4.3.3 无分类编制CIDR（构造超网）

#### 1.网络前缀

划分子网在一定程度上缓解了互联网在发展中遇到的困难，然而在1992年互联网任然面临3个必须尽早解决的问题：

- B类地址在1992年已经分配了一半，马上就将全部分配完毕。
- 互联网主干网上的路由表中的项目数急剧增长。
- 整个IPv4的地址空间最终将全部耗尽。

在一个划分子网的网络中可以同时使用几个不同的子网掩码，使用**变长子网掩码VLSM**可以进一步提高IP地址资源的利用率。在VLSM的基础上又进一步研究出**无分类编制**方法，它的正式姓名是**无分类域间路由选择CIDR**

CIDR最主要的特点有两个：

- **CIDR消除了传统的A类，B类和C类地址以及划分子网的概念**，可以更有效地分配IPv4地地址空间，并且在新的IPv6使用之前容许互联网地规模持续增长。CIDR把32位的IP地址划分为前后两个部分。前面部分是**网络前缀**，用来指明网络，后面部分则用来指明主机。因此CIDR使IP地址从三级编制（使用子网掩码）又回到了两级编制，但这是**无分类的两级编制**，其记法：

  IP地址::={<网络前缀>，<主机号>}

  CIDR还使用**斜线记法**，或称为CIDR记法，即在IP地址后面加上斜线“/”，然后写上网络前缀所占的位数。

- CIDR把**网络前缀都相同**的连续的IP地址组成一个“**CIDR地址块**”。我们只要知道CIDR地址块中的任何一个地址，就可以知道这个地址块的起始地址（最小地址）和最大地址，以及地址块中的地址数，例如，已知IP地址128.14.35.7/20是某CIDR地址快中的一个地址，现在写成二进制表示，其中的前20位是网络前缀（用粗体和下划线表示出），而前缀后面的12位是主机号

为了更方便的进行路由选择，CIDR使用32位的**地址编码**。地址掩码由一串1和一串0组成，而1的个数就是网络前缀的长度。

## 4.6 IPv6

## 4.7 IP多播

### 4.7.1 IP多播的基本概念

与多播相比，在一对多的通信中，多播可大大节约网络资源。

在互联网范围的多播要靠路由器来实现，这些路由器必须增加一些能够识别多播数据报的文件。能够运行多播协议的路由器称为**多播路由器**

在互联网上进行多播就叫做**IP多播**。IP多播所传送的分组需要使用多播IP地址。

## 4.8 虚拟专用网VPN和网络地址转换NAT

### 4.8.1 虚拟专用网

为了解决这一问题，RFC1918指明了一些专用地址。这些地址只能用于一个机构的内部通信，而不能用于和互联网上的主机通信。**在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发**2013年5月，RFC6890全面地给出了所有特殊用途地IPv4地址，但三个专用地址块地指派并无变化，即

- 10.0.0.0到10.255.255.255（或记为10.0.0.0/8.它称为24位块）
- 172.16.0.0到172.31.255.255（或记为172.16.0.0/12，它又称为20位块）
- 192.168.0.0到192.168.255.255（或记为192.168.0.0/16，它又称为16位块）

上面的三个地址块分别相当于一个A类网络，16个连续地B类网络和256个连续地C类网络。

采用这样的专用IP地址地互联网络称为**专用互联网**或**本地互联网**，或更简单些，就叫**专用网**。显然，全世界可能有很多的专用互联网络具有相同的IP地址，但这并不会引起麻烦，因为这些专用地址仅在本机构内部使用。专用IP地址也可叫做**可重复地址**

### 4.8.2 网络地址转换NAT

**网络地址转换NAT**方法在1994年提出。这张方法需要在专用网连接到互联网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，他至少有一个有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和互联网连接。