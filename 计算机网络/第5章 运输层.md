计算机网络

# 第5章 运输层

运输层是整个互联网体系结构中的关键层次之一，一定要弄清楚以下一些重要概念：

- 运输层为相互通信的应用进程提供逻辑通信。
- 端口和套接字的意义
- 无连接的UDP的特点
- 面向连接的TCP的特点
- 在不可靠的网络上实现可靠传输的工作原理，停止等待协议和ARQ协议
- TCP的滑动窗口，流量控制，拥塞控制和连接管理

## 5.1 运输层协议概论

### 5.1.1 进程之间的通信

从通信和信息处理的角度看，**运输层向它上面的应用层提供通信服务**，它属于面向通信部分的最高层，同时也是用户功能中的最低层。

真正进行通信的是这台主机中的一个**进程**和另一台主机中的一个**进程**在交换数据。两台主机进行通信就是两台主机中的**应用进程互相通信**

运输层有一个很重要的功能---**复用**和**分用**

复用指的是发送方不同的应用进程都可以使用同一个运输层协议传送数据，而分用指的是接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进程。

**网络层为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信**然而正如后面还要讨论的，运输层还具有网络层无法替代的许多其他重要功能。

运输层还要对收到的报文进行**差错检测**。在网络层，IP数据报首部中的检验和字段，只检验首部是否出现差错而不检查数据部分。

根据应用程序的不同需求，运输层需要两种不同的运输协议，即**面向连接的TCP和无连接的UDP**

我们还应指出，**运输层向高层用户屏蔽了下面网络核心的细节**（如网络拓扑，所采用的路由选择协议等），**它使应用进程看见的好像在两个运输层实体之间有一条端到端的逻辑通信信道**，但这条逻辑通信信道对上层的表现却因运输层使用的不同协议而有很大的差别。当运输层**采用面向连接的TCP协议时，尽管下面的网络是不可靠的**（只提供尽最大努力服务），但这种逻辑通信信道就相当于**一条全双工的可靠信道**。当运输层采用**无连接的UDP协议**时，这种逻辑信道仍然是一条**不可靠信道**

### 5.1.2 运输层的两个主要协议

TCP/IP运输层的两个主要协议都是互联网的正式标准：

- 用户数据报协议UDP
- 传输控制协议TCP

按照OSI的术语，两个对等运输实体在通信时传送的数据单元叫做**运输协议数据单元TPDU**。但在TCP/IP体系中，则根据所使用的协议是TCP或UDP，分别称之为**TCP报文段**。或**UDP用户数据报**

UDP在传送数据之前**不需要先建立连接**。

TCP则**提供面向连接的服务**

### 5.1.3 运输层的端口

运输层的复用和分用功能也是类似的。应用层所有的应用进程都可以通过运输层再传送到IP层（网络层），这就是**复用**。运输层从IP层收到发送给各应用进程的数据后，必须分别交付指明的各应用进程，这就是**分用**。

为了使运行不同操作系统的计算机的应用进程能够相互通信，我们在运输层使用**协议端口号**，或者简称为**端口**。这就是说，虽然通信的终点是应用进程，但是只要把所传送的报文交到目的主机的某个合适的目的端口，剩下的工作就由TCP/UDP来完成。

这种**在协议栈层间的抽象的协议端口是软件端口**，和路由器或交换机上的硬件端口是完全不同的概念。硬件端口是**不同硬件设备**进行交互的接口，而**软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址**。不同的系统实现端口的方法是不同的。

在后面讲到的UDP和TCP的首部格式中，我们将会看到它们都有**源端口**和**目的端口**这两个重要的字段。当运输层收到IP层交上来的运输层报文时，就能够根据其首部中的目的端口号把数据交付应用层的目的应用进程。

TCP/IP的运输层用一个16位**端口号**来标志一个端口，**端口号只具有本地意义**，他只是为了标志**本计算机**应用层中的各个进程在和运输层交互时的层间接口。在互联网不同的计算机中，相同的端口号是**没有关联的**。

运输层的端口号分为下面的两大类：

- **服务器端使用的端口号** 又分为两类，最重要的一类叫做**熟知端口号**或**系统端口号**。另一类叫做**登记端口号**
- **客户端使用的端口号** 又叫做**短暂端口号**

## 5.2 用户数据报协议UDP

### 5.2.1 UDP概述

用户数据报协议UDP只在IP的数据报服务之上增加了很少一点的功能，这就是复用和分用的功能以及差错检测的功能。UDP的主要特点是：

- UDP是**无连接的**
- UDP使用**尽最大努力交付**，即不保证可靠交付
- UDP是**面向报文的**的
- UDP**没有拥塞控制**
- UDP**支持一对一，一对多，多对一和多对多的交互通信**
- **UDP的首部开销小**，只有8个字节，比TCP的20个字节的首部要短

### 5.2.2 UDP的首部格式

用户数据报UDP有两个字段：数据字段和首部字段。首部字段只有八个字节，由四个字段组成，**每个字段的长度都是两个字节。**各字段意义如下：

- **源端口**
- **目的端口**
- **长度**
- **校验和**

当运输层从IP层收到UDP数据报时，就根据首部中的目的端口，把UDP数据报通过相应的端口，上交最后的终点---应用进程

UDP计算校验和的方法和计算IP数据报首部校验和的方法相似。但不同的是：IP数据报的校验和只检验IP数据报的首部，但UDP的校验和是**把首部和数据部分一起都校验**。

## 5.3 传输控制协议TCP概述

### 5.3.1 TCP的最主要的特点

TCP是TCP/IP体系中非常复杂的一个协议。下面介绍TCP最主要的特点。

- TCP是**面向连接的运输层协议**
- 每一条TCP连接只能有两个**端点**，每一条TCP连接只能是**点对点**的
- TCP提供**可靠交付**的服务
- TCP提供**全双工通道**
- **面向字节流**

### 5.3.2 TCP的连接

TCP把**连接**作为**最基本的抽象**

每一条TCP连接有两个**端点**，TCP连接的端点叫做**套接字**或插口。根据RFC793的定义：端口号**拼接到**IP地址即构成了套接字。因此，套接字的表示方法是在点分十进制的IP地址后面写上端口号，中间用冒号或逗号隔开。我们有：套接字 socket=（IP地址：端口号）

**每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定**。即：

TCP连接：：={socket1，socket2}={（IP1：port1)，（IP2：port2）}

总之，TCP连接就是由协议软件所提供的一种抽象，虽然有时为了方便，我们也可以说，在一个应用进程和另一个应用进程之间建立了一条TCP连接，但一定要记住：**TCP连接的端点是个很抽象的套接字**，即（IP地址：端口号）也还应记住：同一个IP地址可以有不同的TCP连接，而同一个端口号也可以出现在多个不同的TCP连接中。

## 5.4 可靠传输的工作原理

由于TCP发送的报文段是交给IP层传送的，所以TCP下面的网络所提供的是不可靠的传输。因此，TCP必须采用适当的措施才能使得两个运输层之间的通信变得可靠。

### 5.4.1 停止等待协议

我们把A叫做**发送方**，B叫做**接收方**。把传送的数据单元都称为分组，而并不考虑数据是在哪一个层次上传送的。停止等待就是没发送完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组。

#### 1.无差错情况

#### 2.出现差错

#### 3.确认丢失和确认迟到

#### 4.信道利用率

### 5.4.2 连续ARQ协议





