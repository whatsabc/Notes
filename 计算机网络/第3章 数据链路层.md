计算机网络

# 第3章 数据链路层

数据链路层属于计算机网络的低层。数据链路层使用的信道主要有以下两种类型

- **点对点信道**：这种信道使用一对一的点对点通信方式。
- **广播信道**：这种信道使用一对多的广播通信方式。

本章最重要的内容是：

1. 数据链路层的点对点信道和广播信道的特点，以及这两种信道所使用的协议（PPP协议以及CSMA/CD协议）的特点。
2. 数据链路层的三个基本问题：**封装成帧，透明传输和差错检验**
3. 以太网MAC层的硬件地址
4. 适配器，转发器，集线器，网桥，以太网交换机的作用以及使用场合

## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

**链路**就是一个结点到**相邻结点**的一段物理线路，中间没有其他的交换结点。在进行数据通信时，两台计算机之间的通信路径往往要经过许多段这样的链路。可见链路只是一条路径的组成成分。

**数据链路**是另一个概念，因为当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输，若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。现在最常用的方法是使用**网络适配器**（既有硬件，也包括软件）来实现协议。一般的适配器都包括了数据链路层和物理层这两层的功能。

> 点对点信道的数据链路层的协议数据单元---**帧**
>
> 数据链路层把网络层交下来的数据构成帧发送到链路上，以及把收到的帧中的数据并上交给网络层。在互联网中，网络层协议数据单元就是IP数据报（或简称为**数据报**，**分组**或**包**）

### 3.1.2 三个基本问题

#### 1.封装成帧

**封装成帧**就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。

在帧的数据部分的前面和后面分别添加上首部和尾部，构成了一个完整的帧。这样的帧就是数据链路层的数据传送单元。一个帧的帧长等于帧的数据部分长度加上帧首部和尾部的长度。首部和尾部的一个重要作用就是进行**帧定界**。

当数据是由可打印的ASCII码组成的文本文件时，帧界定可以使用特殊的**帧定界符**。ASCII码是7位编码，一共可以组合成128个不同的ASCII码，其中可打印的有95个，不可打印的控制字符有33个。控制字符SOH放在一帧的最前面，表示帧的首部开始。另一个控制字符EOT表示帧的结束。SOH和EOT都是控制字符的名称。它们的16进制编码分别是01（二进制是00000001）和04（二进制是00000100）。

当传输过程出现差错，帧界定符可以用来判别收到的数据是否完整。

#### 2.透明传输

当传送的帧使用文本文件组成的帧时，其数据部分显然不会出现像SOH或EOT这样的帧定界控制字符。可见不管从键盘上输入什么字符都可以放在这样的帧中传输过去，因此这样的传输就是透明传输。

当数据部分时非ASCII码的文本文件时（如二进制代码的计算机程序或图像等）。如果数据中的某个字节的二进制代码恰好和SOH或EOT这种控制字符一样，数据链路层就会**错误的**把剩下的数据丢弃。

解决方式是：发送端的数据链路层在**数据中**出现控制字符“SOH”或“EOT”的前面插入一个**转义字符**“ESC”（其十六进制编码是1B，二进制位00011011）。而在接收端的数据链路层再把数据送往网络层之前删除这个插入的转义字符。这种方法称为**字节填充**或**字符填充**。如果转义字符也出现在数据当中，那么解决方法仍然是在转义字符的前面插入一个转义字符。因此当接收端收到连续的两个转义字符时，就删除其中前面的一个。

#### 3.差错检验

比特在传输过程中可能会产生差错：1可能会变成0，而0也可能变成1。这叫做**比特差错**。

## 3.2 点对点协议PPP

在通信线路质量较差的年代，在数据链路层使用可靠传输协议曾经是一种好办法。因此，能够实现可靠传输的**高级数据链路控制（HDLC）**非常流行。后来，简单得多的**点对点协议PPP**则是目前使用的最广泛的数据链路层协议。

### 3.2.1 PPP协议的特点

用户通常要连接到某个ISP才能接入到互联网。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。

#### 1.PPP协议应满足的需求

1. **简单**

数据链路层没有必要提供比IP协议更多的功能。因此，对数据链路层的帧，不需要纠错，不需要序号，也不需要流量控制。

接收方每收到一个帧，就进行CRC检验，如果CRC检验正确，就收下这个帧；反之，就丢弃这个帧，**其它什么都不做**

1. **封装成帧**
2. **透明性**
3. **多种网络层协议**

PPP协议必须能够在**同一条物理链路上同时支持多种网络层协议（如IP和IPX等）**的运行。当点对点链路所连接的是局域网或路由器时，PPP协议必须同时支持链路所连接的局域网或路由器上运行的各种网络层协议。

4. **多种类型链路**

除了要支持多种网络层的协议外，PPP还必须能够在多种类型的链路上运行。例如，串行的或并行的，同步的或异步的，低速的或高速的···

5. **差错检验**

PPP协议必须能够对接收端收到的帧进行检验，并**立即丢弃有差错的的帧**。

6. **检验连接状态**
7. **最大传送单元**

PPP协议必须对每一种类型的点对点链路设置**最大传送单元**MTU的标准默认值

8. **网络层地址协商**
9. **数据压缩协商**

#### 2.PPP协议的组成

PPP协议有三个组成部分

1. 一个将IP数据报封装到串行链路的方法。
2. 一个用来建立，配置和测试数据链路连接的**链路控制协议LCP**
3. 一套**网络控制协议NCP**，其中的每一个协议支持不同的网络层协议，如IP，OSI的网络层

### 3.2.2 PPP协议的帧格式

#### 1.各字段的意义

PPP帧的首部和尾部分别位四个字段和两个字段。

#### 2.字节填充

#### 3.零比特填充

### 3.2.3 PPP协议的工作状态

当用户拨号接入ISP后，就建立了一条从用户个人电脑到ISP的物理连接，这时，用户个人电脑向ISP发送一系列的链路控制协议LCP分组（封装成多个PPP帧），以便建立LCP连接。这些分组及其响应选择了将要使用的一些PPP参数。接着还要进行网络层配置，网络控制协议NCP给新接入的个人电脑分配一个临时的IP地址。这样，用户个人电脑就成为互联网上一个有IP地址的主机了。

## 3.3 使用广播信道的数据链路层

### 3.3.1 局域网的数据链路层

局域网的最主要特点：**网络为一个单位所拥有，且地理范围和站点数目有限**。

局域网具有以下主要优点：

- 具有广播功能
- 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变
- 提高了系统的可靠性，可用性和生存性

局域网按网络拓扑进行分类：

- **星形网**
- **环型网**
- **总线网**（以传统以太网最为出名）

现在以太网几乎成了局域网的同义词，之后讨论的都是以太网技术。

共享信道要着重考虑的一个问题就是如何使众多用户能够合理而方便地共享通信媒体资源，这在技术上有两种方法：

1. **静态划分信道** 之前讲的频分复用，时分复用，波分复用，但是这种划分信道的方法代价较高，不适合局域网使用。

2. **动态媒体介入控制** 他又称为**多点接入**，其特点是信道并非在用户通信时固定分配给用户，这里又分为以下两类
   - **随机接入**
   - **受控接入**

#### 1.以太网的两个标准

#### 2.适配器的作用

计算机与外界局域网的连接是通过通信**适配器**进行的。适配器本来是主机箱内插入的一块网络接口板。这种接口板又称为**网络接口卡NIC**或简称为**网卡**。

网卡上装有处理器和储存器（包括RAM和ROM），需要注意的是，计算机的硬件地址，在适配器的ROM中，计算机的软件地址---IP地址，在计算机的储存器中。

### 3.3.2 CSMA/CD协议（载波监听多点接入/碰撞检测）

为了通信的简便，以太网采取了以下两种措施：

- 第一，采用较为灵活的**无连接**的工作方式，不必先建立连接就可以直接发送数据。适配器对发送的数据帧不进行编号，也不要求对方发回确认。**以太网提供的服务是尽最大努力的交付，即不可靠的交付**。当目的站收到有差错的数据帧时，就把帧丢弃，其他什么也不做。**对有差错帧是否需要重传则由高层来决定**。例如，如果高层使用TCP协议，那么TCP就会发现丢失了一些数据。于是经过一段事件后，TCP就把这些数据重新传递给以太网进行重传。**但以太网并不知道这是重传帧，而是当作新的数据帧来发送**。

  以太网采用CSMA/CD，**载波监听多点接入/碰撞检测**

- 以太网发送的数据都使用**曼彻斯特编码**的信号。

重点介绍CSMA/CD协议的要点：

**多点接入**就是说明这是总线型网络，许多计算机以多点接入的方式连接在一根总线上。协议的实质就是“载波监听”和“碰撞检测”。

**载波监听**就是用电子技术检测总线上有没有其他计算机也在发送。载波监听就是**检测信道**，这是一个很重要的措施。**不管在发送前，还是在发送中，每个站都必须不停的检测信道**。

**碰撞检测**也就是**边发送边监听**。即适配器边发送数据边检测信道上的信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。

显然，在使用CSMA/CD协议时，一个站**不可能同时进行发送和接受（但必须边发送边监听信道）**。因此使用CSMA/CD协议的以太网不可能进行全双工通信而只能进行**半双工通信**

### 3.3.3 使用集线器的星型拓扑

传统以太网最初使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜的和更灵活的双绞线。这种以太网采用星形拓扑，星形的中心则增加了一种可靠性非常高的设备，叫做**集线器**。

集线器的一些特点如下;

1. 从表面看，使用集线器的局域网在物理上是一个星形网，但由于集线器使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个传统以太网那样运行。也就是说，**使用集线器的以太网在逻辑上任然是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议**（更具体些说，是各站中的**适配器**执行CSMA/CD协议）。网络中的各站必须竞争对传输媒体的控制，并且在**同一时刻至多只允许一个站发送数据**。
2. 一个集线器有许多**接口**
3. **集线器工作在物理层，**他的每个接口仅仅**简单地转发比特，不进行碰撞检测**
4. 集线器采用了专门的芯片，进行自适应串音回波抵消。

### 3.3.4 以太网的信道利用率

### 3.3.5 以太网的MAC层

#### 1.MAC层的硬件地址

在局域网中，**硬件地址**又称为**物理地址**或**MAC地址**（因为这种地址用在MAC帧中）

#### 2.MAC帧的格式

以太网V2的MAC帧较为简单，由五个字段组成，前两个字段分别为6字节长的**目的地址**和**源地址**字段，第三个字段是2字节的**类型字段**，用来标志上一层使用的是什么协议，以便把疏导的MAC帧的数据上交给上一层的这个协议。第四个字段是**数据字段**，其长度为46到1500字节之间。最后一个字段是4字节的**帧检验序列**FCS。

还需注意，在以太网上传送数据时是以帧为单位传送的。以太网在传送帧时。各帧之间还必须有一定的间隙。因此，接收端只要找到帧开始定界符，其后面的连续到达的比特流就都属于同一个MAC帧。可见以太网不需要使用帧技术定界符，也不需要使用字节插入来保证透明传输。

## 3.4 扩展的以太网

在许多情况下，我们希望对以太网的覆盖范围进行扩展。本节先讨论在物理层对以太网扩展，然后讨论在数据链路层对以太网扩展。**这种扩展的以太网在网络层看来仍然是一个网络**。

### 3.4.1 在物理层扩展以太网

现在，扩展主机和集线器之间的距离的一种简单方法就是使用光纤（通常是一对光纤）和一对光纤调制解调器。

光线调制解调器的作用就是进行电信号和光信号的转换。由于光纤带来的时延很小，而且带宽很宽，因此使用这种方法可以很容易的使主机和几公里外的集线器相连接。

### 3.4.2 在数据链路层扩展以太网

扩展以太网更常用的方法是在数据链路层进行。最初人们使用的是**网桥**，网桥对收到的帧根据其MAC帧的目的地址进行**转发**和**过滤**。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是根据此帧的目的MAC地址，查找网桥中的地址表，然后确定将改帧转发到哪一个接口，或者是把它丢弃。

1990年问世的**交换式集线器**，很快淘汰了网桥。又被称为以太网**交换机**或者**第二层交换机**，强调这种交换机**工作在数据链路层**。

#### 1.以太网交换机的特点

实质上就是一个**多接口的网桥**，通常有十几个或更多的接口，和工作在物理层的转发器，集线器有很大的区别。以太网交换机的每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般工作在全双工方式。

以太网交换机是一种即插即用设备，其内部的**帧交换表**（又称为**地址表**）是通过**自学习**算法自动的逐渐建立起来的。以太网交换机由于使用了专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多。

以太网交换机的性能远远超过普通的集线器，价格不贵，这就使工作在物理层的集线器逐渐的退出了市场

#### 2.以太网交换机的自学习功能

#### 3.从总线以太网到星型以太网

总线以太网使用CSMA/CD协议，以半双工方式工作。但以太网交换机不适用共享总线，没有碰撞问题，因此不使用CSMA/CD协议，而是以全双工方式工作。既然连以太网的重要协议CSMA/CD都不使用了，为什么还叫作以太网呢？因为**以太网的帧结构未改变**，所以还叫作以太网，与不使用CSMA/CD协议无关。

### 3.4.3 虚拟局域网

利用以太网交换机可以很方便的实现**虚拟以太网（VLAN）**。

## 3.5 高速以太网

### 3.5.1 100BASE-T以太网

100BASE-T以太网是在双绞线上传送100Mbit/s基带信号的星型拓扑以太网，仍使用IEEE802.3的CSMA/CD协议。它又称为**快速以太网**。

100BASE-T可使用以太网交换机提供很好的服务质量，可以在全双工方式下工作而无冲突发生。因此，CSMA/CD协议对全双工方式工作的快速以太网是不起作用的（但在半双工方式工作时则一定要使用CSMA/CD协议）

### 3.5.2 吉比特以太网

### 3.5.3 10吉比特以太网和更快的以太网

**10GE只工作在全双工方式，因此不存在争用问题，当然也不使用CSMA/CD协议**

### 3.5.4 使用以太网进行宽带接入

使用以太网也可以进行宽带接入互联网。以太网接入的一个重要特点是它可以提供双向的宽带通信，并且可以根据用户对宽带的需求灵活进行宽带升级。当城域网和广域网都采用吉比特以太网或10吉比特以太网时，采用以太网接入可以实现端到端的以太网传输，中间不需要再进行帧格式的转换。这就提高了数据的传输效率且降低了传输的成本。

为了让网络运营商利用以太网接入到互联网，让用户键入密码来鉴定用户身份，人们把数据链路层的两个成功的协议结合起来，即把PPP协议中的PPP帧再封装到以太网中来传输，这就是PPPoE，意思是在以太网上运行PPP。现在的光纤宽带接入FFFx都要使用PPPoE的方式进行接入。

